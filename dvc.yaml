stages:
  preprocess:
    cmd: python src/preprocess.py
    deps:
      - ${system.traces}/${apps.app}
      - src/preprocess.py
      - src/data_loader.py
    params:
      - system
      - apps.app
      - teacher.number
      - trace-data
      - hardware
    outs:
      - ${system.processed}/train_loader_1.pt
      - ${system.processed}/test_loader_1.pt
      - ${system.processed}/df_test_1.pt
      - ${system.processed}/train_loader_2.pt
      - ${system.processed}/test_loader_2.pt
      - ${system.processed}/df_test_2.pt
      - ${system.processed}/train_loader_3.pt
      - ${system.processed}/test_loader_3.pt
      - ${system.processed}/df_test_3.pt
      - ${system.processed}/train_loader_4.pt
      - ${system.processed}/test_loader_4.pt
      - ${system.processed}/df_test_4.pt
      - ${system.processed}/train_loader_5.pt
      - ${system.processed}/test_loader_5.pt
      - ${system.processed}/df_test_5.pt
      - ${system.processed}/test_loader_stu.pt
      - ${system.processed}/df_test_stu.pt

  train-tchs:
    cmd: python src/train_tch.py
    deps:
      - ${system.processed}/train_loader_1.pt
      - ${system.processed}/test_loader_1.pt
      - ${system.processed}/train_loader_2.pt
      - ${system.processed}/test_loader_2.pt
      - ${system.processed}/train_loader_3.pt
      - ${system.processed}/test_loader_3.pt
      - ${system.processed}/train_loader_4.pt
      - ${system.processed}/test_loader_4.pt
      - ${system.processed}/train_loader_5.pt
      - ${system.processed}/test_loader_5.pt
      - src/train_tch.py
    params:
      - teacher
      - model.tch_${teacher.models[0]}
      - model.tch_${teacher.models[1]}
      - model.tch_${teacher.models[2]}
      - model.tch_${teacher.models[3]}
      - model.tch_${teacher.models[4]}
      - system
      - hardware
      - train
    metrics:
      - res/plots/metrics/train_tch_1/test_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_1/train_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_2/test_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_2/train_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_3/test_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_3/train_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_4/test_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_4/train_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_5/test_loss.tsv:
          cache: false
      - res/plots/metrics/train_tch_5/train_loss.tsv:
          cache: false
    outs:
      - ${system.model}/teacher_1.pth
      - ${system.model}/teacher_2.pth
      - ${system.model}/teacher_3.pth
      - ${system.model}/teacher_4.pth
      - ${system.model}/teacher_5.pth


  validate-tchs:
    cmd: python src/validate_tch.py
    deps:
      - ${system.processed}/test_loader_1.pt
      - ${system.processed}/test_loader_2.pt
      - ${system.processed}/test_loader_3.pt
      - ${system.processed}/test_loader_4.pt
      - ${system.processed}/test_loader_5.pt
      - ${system.processed}/df_test_1.pt
      - ${system.processed}/df_test_2.pt
      - ${system.processed}/df_test_3.pt
      - ${system.processed}/df_test_4.pt
      - ${system.processed}/df_test_5.pt
      - ${system.model}/teacher_1.pth
      - ${system.model}/teacher_2.pth
      - ${system.model}/teacher_3.pth
      - ${system.model}/teacher_4.pth
      - ${system.model}/teacher_5.pth
      - src/validate_tch.py
    params:
      - teacher
      - model.tch_${teacher.models[0]}
      - model.tch_${teacher.models[1]}
      - model.tch_${teacher.models[2]}
      - model.tch_${teacher.models[3]}
      - model.tch_${teacher.models[4]}
      - apps.app
      - system
      - hardware
    # metrics:
    #   - res/teacher_1.json:
    #       cache: false
  # train-stu:
  #   cmd: python src/train_stu.py
  #   deps:
  #     - ${system.model}/teacher_1.pth
  #     - ${system.processed}/train_loader_1
  #     - ${system.processed}/test_loader_1
  #     - src/train_stu.py
  #   params:
  #     - student.model
  #     - model.stu_${student.model}
  #     - teacher.model
  #     - model.tch_${teacher.model}
  #     - system
  #     - hardware
  #     - train
  #   metrics:
  #     - res/plots/metrics/train_stu/test_loss.tsv:
  #         cache: false
  #     - res/plots/metrics/train_stu/train_loss.tsv:
  #         cache: false
  #   outs:
  #     - ${system.model}/student.pth
  
  # validate-stu:
  #   cmd: python src/validate_stu.py
  #   deps:
  #     - ${system.processed}/test_loader_1
  #     - ${system.processed}/test_df_1
  #     - ${system.model}/student.pth
  #     - src/validate_stu.py
  #   params:
  #     - student
  #     - model.stu_${student.model}
  #     - apps.app
  #     - system
  #     - hardware
  #   metrics:
  #     - res/student.json:
  #         cache: false
  
# plots:
#   - train-tch-1:
#       y:
#         res/plots/metrics/train_tch_1/train_loss.tsv: train_tch_1/train_loss
#         res/plots/metrics/train_tch_1/test_loss.tsv: train_tch_1/test_loss
#       y_label: loss
#   - train-stu:
#       y:
#         res/plots/metrics/train_stu/train_loss.tsv: train_stu/train_loss
#         res/plots/metrics/train_stu/test_loss.tsv: train_stu/test_loss
#       y_label: loss
